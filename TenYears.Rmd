# Install relevant packages and libraries

```{r}
library(ggplot2)
library(tidyr)
library(RColorBrewer)
library(TraMineR)
library(cluster)
library(dplyr)
library(gridExtra)
```

# Prepare the fuel poverty data

## Read data as csv.

```{r}
LA_data <- read.csv("FP_LA_Data_Percent.csv", check.names=FALSE, fileEncoding = 'UTF-8-BOM')
LA_data
```
## Convert data into long format

```{r}
LA_data_long <- gather(LA_data, key="Year", value="FP_households", c(4:13))
head(LA_data_long)
```

## Make sure that R recognises the year format as a date

```{r}
LA_data_long$Year<-lubridate::ymd(LA_data_long$Year, truncated = 2L)
head(LA_data_long)
```

# Sequence analysis

## Compute a relative rank / decile for each fuel poor households for each year

```{r}
colnames(LA_data)
LA_data_deciles = mutate(LA_data, x2010 = ntile(LA_data$"2010", 10), 
                                  x2011 = ntile(LA_data$"2011", 10), 
                                  x2012 = ntile(LA_data$"2012", 10), 
                                  x2013 = ntile(LA_data$"2013", 10), 
                                  x2014 = ntile(LA_data$"2014", 10),
                                  x2015 = ntile(LA_data$"2015", 10), 
                                  x2016 = ntile(LA_data$"2016", 10), 
                                  x2017 = ntile(LA_data$"2017", 10), 
                                  x2018 = ntile(LA_data$"2018", 10),
                                  x2019 = ntile(LA_data$"2019", 10))
LA_data_deciles
```

## Specify the stages of the sequence that we are interested in, i.e. deciles (1-10)

```{r}
data_alpha <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10") # Create list of states
```

## Create a state sequence object from the fuel poverty variables (x2010 - x2019)

```{r}
LA_seq <- seqdef(LA_data_deciles, 14:23, ststep=NULL, alphabet=data_alpha) # Alphabet is the list of states
```

## Caluculate transition rate

```{r}
LA_seq_tr <- seqsubm(LA_seq, method = "TRATE", time.varying = TRUE)
tr_rates <- round(LA_seq_tr, 2)
tr_rates

write.csv(tr_rates, "tr_rates.csv") 
```

## Set the colour palette according to the sequence
```{r}
cpal(LA_seq) <- c("#313695", "#4575b4", "#74add1", "#abd9e9", 
                  "#e0f3f8", "#fee090", "#fdae61", "#f46d43", "#d73027", "#a50026")
```

## Compute pairwise optimal matching (OM) distances between sequences
### With an insertion/deletion cost of 1 and a substitution cost matrix based on observed trandition rate
### The function seqcost proposes different ways to generate substitution costs (supposed to re???ect state dissimilarities) and possibly indel costs. 
### Proposed methods is "TRATE" (derived from the observed transition rates). Thesubstitutioncost matrix is intended to serve as sm argument in the seqdist function that computes distances between sequences. seqsubm is an alias that returns only the substitution cost matrix, i.e., no indel.

```{r}
LA_om <- seqdist(LA_seq, method = "OMspell", indel = 1, sm = "TRATE")
```

# Agglomerative hierarchical clustering 

## Using the obtained distance matrix, select each n cluster solution and express it as a factor

```{r}
LA_cluster <- agnes(LA_om, diss=TRUE, method ="ward")

fp.cl4<-cutree(LA_cluster, k=4) # Select k=n cluster solution
LA_data_deciles$clustering4 <- cutree(LA_cluster, k=4) # Add cluster number to data frame for each k=n)
cl4.lab <- factor(fp.cl4, labels = paste("Cluster", 1:4)) # Express as a factor to create labels       

fp.cl5<-cutree(LA_cluster, k=5)
LA_data_deciles$clustering5 <- cutree(LA_cluster, k=5)
cl5.lab <- factor(fp.cl5, labels = paste("Cluster", 1:5))

fp.cl6<-cutree(LA_cluster, k=6)
LA_data_deciles$clustering6 <- cutree(LA_cluster, k=6)
cl6.lab <- factor(fp.cl6, labels = paste("Cluster", 1:6))

fp.cl7<-cutree(LA_cluster, k=7)
LA_data_deciles$clustering7 <- cutree(LA_cluster, k=7)
cl7.lab <- factor(fp.cl7, labels = paste("Cluster", 1:7))

fp.cl8<-cutree(LA_cluster, k=8)
LA_data_deciles$clustering8 <- cutree(LA_cluster, k=8)
cl8.lab <- factor(fp.cl8, labels = paste("Cluster", 1:8))

## Create csv. file of cluster data for use in mapping

```{r}
write.csv(LA_data_deciles, "data_deciles.csv") 
```

# Visualise cluster patterns

## State distribution plots
### See: http://traminer.unige.ch/doc/seqplot.html

```{r}
seqdplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqdplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqdplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqdplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqdplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Sequence frequency plots

```{r}
seqfplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqfplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqfplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqfplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqfplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Transversal entropy plots

```{r}
seqHtplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqHtplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqHtplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqHtplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqHtplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Mean times plots

```{r}
seqmtplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqmtplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqmtplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqmtplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqmtplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Whole set index plots

```{r}
seqIplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqIplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqIplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqIplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqIplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Individual sequences
### Plots the first ten rows of the sequence object. 

```{r}
seqiplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqiplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqiplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqiplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqiplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Parallel coordinate plots

```{r}
seqpcplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqpcplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqpcplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqpcplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqpcplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

## Modal state sequences

```{r}
seqmsplot(LA_seq, group = cl4.lab, border = NA, rows = 3, cols = 3)
seqmsplot(LA_seq,group = cl5.lab, border = NA, rows = 3, cols = 3)
seqmsplot(LA_seq, group = cl6.lab, border = NA, rows = 3, cols = 3)
seqmsplot(LA_seq, group = cl7.lab, border = NA, rows = 3, cols = 3)
seqmsplot(LA_seq, group = cl8.lab, border = NA, rows = 3, cols = 3)
```

# Contextualise trajectories with Census data

## Add additional Census variables

```{r}
LA_additional_variables <- read.csv("LA_variables.csv", check.names=FALSE, fileEncoding = 'UTF-8-BOM')
LA_finaldataset <- merge(LA_data_deciles, LA_additional_variables, by.x=c("LACode"), by.y=c("geography code"))
```

## Check and change type of variable

```{r}
str(LA_finaldataset)

LA_finaldataset$clustering5 <- as.character(LA_finaldataset$clustering5) # Change cluster variable to character rather than numeric
str(LA_finaldataset)
```

## Create violin plot for unpaid care

```{r}
p1 <- ggplot(LA_finaldataset, aes(x=clustering5, y = UnpaidCare_person_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Unpaid care",y="Percentage of persons", x="", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10), axis.title.y=element_text(size=10)) 
```

## Private rent

```{r}
h1 <- ggplot(LA_finaldataset, aes(x=clustering5, y = PrivateRent_hh_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Private renting",y="Percentage of households", x="", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10), axis.title.y=element_text(size=10))
```

## Social rent

```{r}
h2 <- ggplot(LA_finaldataset, aes(x=clustering5, y = SocialRent_hh_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Social renting",y="", x="Clusters", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10), axis.title.x=element_text(size=10))
```

## Ethnicity

```{r}
p2 <- ggplot(LA_finaldataset, aes(x=clustering5, y = Ethnicity_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Ethnic minority", x="", y = "", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10)) 
```

## Deprivaton

```{r}
h3 <- ggplot(LA_finaldataset, aes(x=clustering5, y = Deprivation_hh_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Deprivation",y="", x="", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10))
```

## No central heating

```{r}
h4 <- ggplot(LA_finaldataset, aes(x=clustering5, y = NoCentralHeating_per_hh))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="No central heating",y="Percentage of households", x="Clusters", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")
```

## Disability or illness

```{r}
p3 <- ggplot(LA_finaldataset, aes(x=clustering5, y = LimitedAlot_person_per))+ 
  geom_violin(aes(fill=clustering5), color=NA)+
  labs(title="Daily activities limited a lot", x = "", y="", caption = "")+
  scale_fill_manual(values=c("#440154", "#3a528b", "#20908d","#5dc962", "#fde725"), 
                    name="Cluster",
                    breaks=c("1", "2", "3", "4", "5"),
                    labels=c("1", "2", "3", "4", "5"))+
  stat_summary(fun.y=median, geom="point", size=2, color="black")+ 
  theme(legend.position = "none", plot.title = element_text(size=10))
```

## Plot multiple graphs on same plot using grid.arrange

```{r}
tiff("Grid_Variables_Clusters_400.tiff", width = 4000, height = 3000, res=400)
grid.arrange(p1, p2, p3, h1, h2, h3,  nrow = 2)
dev.off()
```
